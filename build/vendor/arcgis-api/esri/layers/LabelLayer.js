//>>built
define("esri/layers/LabelLayer","require dojo/_base/declare dojo/_base/lang dojo/number dojo/i18n!dojo/cldr/nls/number dojo/_base/array dojo/_base/connect dojo/has dojox/gfx/_base ../kernel ../lang ../graphic ../PopupInfo ./labelLayerUtils/DynamicLabelClass ./labelLayerUtils/StaticLabelClass ../symbols/TextSymbol ../symbols/ShieldLabelSymbol ../geometry/Extent ../geometry/Point ../geometry/webMercatorUtils ./GraphicsLayer ./LabelClass ../renderers/SimpleRenderer".split(" "),function(n,A,l,B,v,w,s,
C,x,D,y,E,F,G,H,p,t,I,J,z,K,u,L){function M(a){return"sizeInfo"===a.type}n=A(K,{declaredClass:"esri.layers.LabelLayer",constructor:function(a){this._refreshLabels=l.hitch(this,this._refreshLabels);this.id="labels";this.featureLayers=[];this._featureLayerInfos=[];this._preparedLabels=[];this._engineType="STATIC";this._mapEventHandlers=[];a&&(a.id&&(this.id=a.id),a.mode&&(this._engineType="DYNAMIC"===a.mode.toUpperCase()?"DYNAMIC":"STATIC"))},_setMap:function(a){this._mapEventHandlers.push(a.on("extent-change",
l.hitch(this,"_handleLevelChange")));var d=this.inherited(arguments);this.refresh();return d},_unsetMap:function(){var a;for(a=0;a<this._mapEventHandlers.length;a++)s.disconnect(this._mapEventHandlers[a]);this.refresh();clearTimeout(this._refreshHandle);this._refreshHandle=null;this.inherited(arguments)},setAlgorithmType:function(a){this._engineType=a&&"DYNAMIC"===a.toUpperCase()?"DYNAMIC":"STATIC";this.refresh()},addFeatureLayer:function(a,d,c,g){if(!this.getFeatureLayer(a.layerId)){var h=[];h.push(a.on("update-end",
l.hitch(this,"refresh")));h.push(a.on("suspend",l.hitch(this,"refresh")));h.push(a.on("resume",l.hitch(this,"refresh")));h.push(a.on("edits-complete",l.hitch(this,"refresh")));h.push(a.on("labeling-info-change",l.hitch(this,"refresh")));h.push(a.on("time-extent-change",l.hitch(this,"refresh")));h.push(a.on("show-labels-change",l.hitch(this,"refresh")));this._featureLayerInfos.push({FeatureLayer:a,LabelExpressionInfo:c,LabelingOptions:g,LabelRenderer:d,EventHandlers:h});this.featureLayers.push(a);
this.refresh()}},getFeatureLayer:function(a){var d,c;for(d=0;d<this.featureLayers.length;d++)if(c=this.featureLayers[d],void 0!==c&&c.id==a)return c;return null},removeFeatureLayer:function(a){var d;a=this.getFeatureLayer(a);if(void 0!==a&&(d=w.indexOf(this.featureLayers,a),-1<d)){this.featureLayers.splice(d,1);for(a=0;a<this._featureLayerInfos[d].EventHandlers.length;a++)s.disconnect(this._featureLayerInfos[d].EventHandlers[a]);this._featureLayerInfos.splice(d,1);this.refresh()}},removeAllFeatureLayers:function(){var a;
for(a=0;a<this.featureLayers.length;a++){for(var d=0;d<this._featureLayerInfos[a].EventHandlers.length;d++)s.disconnect(this._featureLayerInfos[a].EventHandlers[d]);this.featureLayers=[];this._featureLayerInfos=[]}this.refresh()},getFeatureLayers:function(){return this.featureLayers},getFeatureLayerInfo:function(a){var d,c;for(d=0;d<this.featureLayers.length;d++)if(c=this.featureLayers[d],void 0!==c&&c.id==a)return this._featureLayerInfos[d];return null},refresh:function(){null==this._refreshHandle&&
(this._refreshHandle=setTimeout(this._refreshLabels,0))},_handleLevelChange:function(a){a.levelChange&&this.clear();this.refresh()},_refreshLabels:function(a){this._refreshHandle=null;var d,c,g,h,b,e=[],f,k="DYNAMIC"===this._engineType?new G:new H;if(this._map){k.setMap(this._map,this);this._preparedLabels=[];for(a=0;a<this.featureLayers.length;a++)if(c=this.featureLayers[a],c.visible&&c.showLabels&&c.visibleAtMapScale&&!c._suspended)if(d=this._featureLayerInfos[a],b=this._convertOptions(null),d.LabelRenderer){if(e=
c.labelingInfo)if(f=e[0])h=this._getLabelExpression(f),b=this._convertOptions(f);g=d.LabelRenderer;d.LabelExpressionInfo&&(h=d.LabelExpressionInfo);d.LabelingOptions&&(b=this._convertOptions(null),void 0!==d.LabelingOptions.pointPriorities&&(e=d.LabelingOptions.pointPriorities,b.pointPriorities="above-center"==e||"AboveCenter"==e||"esriServerPointLabelPlacementAboveCenter"==e?"AboveCenter":"above-left"==e||"AboveLeft"==e||"esriServerPointLabelPlacementAboveLeft"==e?"AboveLeft":"above-right"==e||"AboveRight"==
e||"esriServerPointLabelPlacementAboveRight"==e?"AboveRight":"below-center"==e||"BelowCenter"==e||"esriServerPointLabelPlacementBelowCenter"==e?"BelowCenter":"below-left"==e||"BelowLeft"==e||"esriServerPointLabelPlacementBelowLeft"==e?"BelowLeft":"below-right"==e||"BelowRight"==e||"esriServerPointLabelPlacementBelowRight"==e?"BelowRight":"center-center"==e||"CenterCenter"==e||"esriServerPointLabelPlacementCenterCenter"==e?"CenterCenter":"center-left"==e||"CenterLeft"==e||"esriServerPointLabelPlacementCenterLeft"==
e?"CenterLeft":"center-right"==e||"CenterRight"==e||"esriServerPointLabelPlacementCenterRight"==e?"CenterRight":"AboveRight"),void 0!==d.LabelingOptions.lineLabelPlacement&&(b.lineLabelPlacement=d.LabelingOptions.lineLabelPlacement),void 0!==d.LabelingOptions.lineLabelPosition&&(b.lineLabelPosition=d.LabelingOptions.lineLabelPosition),void 0!==d.LabelingOptions.labelRotation&&(b.labelRotation=d.LabelingOptions.labelRotation),void 0!==d.LabelingOptions.howManyLabels&&(b.howManyLabels=d.LabelingOptions.howManyLabels));
g instanceof u&&(h=this._getLabelExpression(g),g=new L(g.symbol),b=this._convertOptions(g));this._addLabels(c,g,h,b)}else if(e=c.labelingInfo)for(d=e.length-1;0<=d;d--)if(f=e[d])g=new u(f instanceof u?f.toJson():f),h=this._getLabelExpression(f),b=this._convertOptions(f),this._addLabels(c,g,h,b);h=k._process(this._preparedLabels);this.clear();this.drawLabels(this._map,h)}},drawLabels:function(a,d){this._scale=(a.extent.xmax-a.extent.xmin)/a.width;var c;for(c=0;c<d.length;c++){var g=d[c],h=g.x,b=g.y,
e=g.text,f=g.angle,k=g.layer.labelSymbol;"polyline"==g.layer.geometry.type&&g.layer.options.labelRotation&&k.setAngle(f*(180/Math.PI));k.setText(e);g=h;k instanceof p&&(h=k.getHeight(),f=Math.sin(f),g-=0.25*h*this._scale*f,b-=0.33*h*this._scale);f=new E(new J(g,b,a.extent.spatialReference));f.setSymbol(k);this.add(f)}},_addLabels:function(a,d,c,g){var h,b,e,f;if(this._isWithinScaleRange(d.minScale,d.maxScale)&&c&&""!==c){var k=this._map,l=!a.url&&!k.spatialReference.equals(a.spatialReference);for(h=
0;h<a.graphics.length;h++)if(b=a.graphics[h],!1!==b.visible){e=b.geometry;if(l){if(!z.canProject(e,k))continue;e=z.project(e,k)}e&&(this._isWhere(d.where,b.attributes)&&this._isWithinScreenArea(e))&&(f=this._buildLabelText(c,b.attributes,a.fields,g),this._addLabel(f,d,a.renderer,b,g,e,k))}}},_isWithinScreenArea:function(a){a="point"===a.type?new I(a.x,a.y,a.x,a.y,a.spatialReference):a.getExtent();if(void 0===a)return!1;a=this._intersects(this._map,a);return null===a||0===a.length?!1:!0},_isWithinScaleRange:function(a,
d){var c=this._map.getScale();return 0<a&&c>=a||0<d&&c<=d?!1:!0},_isWhere:function(a,d){try{if(!a)return!0;if(a){var c=a.split(" ");if(3===c.length)return this._sqlEquation(d[this._removeQuotes(c[0])],c[1],this._removeQuotes(c[2]));if(7===c.length){var g=this._sqlEquation(d[this._removeQuotes(c[0])],c[1],this._removeQuotes(c[2])),h=c[3],b=this._sqlEquation(d[this._removeQuotes(c[4])],c[5],this._removeQuotes(c[6]));switch(h){case "AND":return g&&b;case "OR":return g||b}}}return!1}catch(e){}},_sqlEquation:function(a,
d,c){switch(d){case "\x3d":return a==c?!0:!1;case "\x3c\x3e":return a!=c?!0:!1;case "\x3e":return a>c?!0:!1;case "\x3e\x3d":return a>=c?!0:!1;case "\x3c":return a<c?!0:!1;case "\x3c\x3d":return a<=c?!0:!1}return!1},_removeQuotes:function(a){var d=a.indexOf('"'),c=a.lastIndexOf('"');if(-1!=d&&-1!=c)return a.substr(1,a.length-2);d=a.indexOf("'");c=a.lastIndexOf("'");return-1!=d&&-1!=c?a.substr(1,a.length-2):a},_getSizeInfo:function(a){return a?a.sizeInfo||w.filter(a.visualVariables,M)[0]:null},_addLabel:function(a,
d,c,g,h,b,e){var f,k,m,q;if(a&&""!==l.trim(a)&&d){a=a.replace(/\s+/g," ");f=d.getSymbol(g);f instanceof p?(f=new p(f.toJson()),f.setVerticalAlignment("baseline"),f.setHorizontalAlignment("center")):f=f instanceof t?new t(f.toJson()):new p;f.setText(a);d.symbol=f;if(m=this._getProportionalSize(d.sizeInfo,g.attributes))f instanceof p?f.setSize(m):f instanceof t&&(f.setWidth(m),f.setHeight(m));q=m=0;if(c){k=c.getSymbol(g);var n=this._getSizeInfo(c),r;n&&(r=c.getSize(g,{sizeInfo:n,resolution:e.getResolutionInMeters()}));
if(r&&null!==r)m=q=r;else if(k)if("simplemarkersymbol"==k.type)q=m=k.size;else if("picturemarkersymbol"==k.type)m=k.width,q=k.height;else if("simplelinesymbol"==k.type||"cartographiclinesymbol"==k.type)m=k.width}c={};c.graphic=g;c.options=h;c.geometry=b;c.labelRenderer=d;c.labelSymbol=f;c.labelWidth=f.getWidth()/2;c.labelHeight=f.getHeight()/2;c.symbolWidth=x.normalizedLength(m)/2;c.symbolHeight=x.normalizedLength(q)/2;c.text=a;c.angle=f.angle;this._preparedLabels.push(c)}},_buildLabelText:function(a,
d,c,g){return a.replace(/{[^}]*}/g,function(a){var b,e=a;for(b=0;b<c.length;b++)if("{"+c[b].name+"}"==a){var e=d[c[b].name],f=c[b].domain;if(f&&l.isObject(f)){if("codedValue"==f.type&&g.useCodedValues){b=e;for(a=0;a<f.codedValues.length;a++)if(f.codedValues[a].code==b){e=f.codedValues[a].name;break}}else"range"==f.type&&(f.minValue<=e&&e<=f.maxValue)&&(e=f.name);break}f=c[b].type;if(g.fieldInfos){var k=g.fieldInfos;for(b=0;b<k.length;b++)if("{"+k[b].fieldName+"}"==a){a=k[b].format;if("esriFieldTypeDate"==
f)(a="DateFormat"+F.prototype._dateFormats[a.dateFormat?a.dateFormat:"shortDate"])&&(e=y.substitute({myKey:e},"${myKey:"+a+"}"));else if(("esriFieldTypeInteger"==f||"esriFieldTypeSingle"==f||"esriFieldTypeSmallInteger"==f||"esriFieldTypeLong"==f||"esriFieldTypeDouble"==f)&&a)e=B.format(e,{places:a.places}),a.digitSeparator||v.group&&(e=e.replace(RegExp("\\"+v.group,"g"),""));break}}break}else e="";return null===e?"":e})},_getLabelExpression:function(a){return a.labelExpressionInfo?a.labelExpressionInfo.value:
this._validSyntax(a.labelExpression)?this._convertLabelExpression(a.labelExpression):""},_validSyntax:function(a){return/^(\s*\[[^\]]+\]\s*)+$/i.test(a)},_convertLabelExpression:function(a){return a.replace(RegExp("\\[","g"),"{").replace(RegExp("\\]","g"),"}")},_getProportionalSize:function(a,d){if(!a)return null;var c=y.substitute(d,"${"+a.field+"}",{first:!0});return!a.minSize||!a.maxSize||!a.minDataValue||!a.maxDataValue||!c||0>=a.maxDataValue-a.minDataValue?null:(a.maxSize-a.minSize)/(a.maxDataValue-
a.minDataValue)*(c-a.minDataValue)+a.minSize},_convertOptions:function(a){var d=!0,c="shortDate",g=null,h=null,b="",e=!0;a&&(a.format&&(c=a.format.dateFormat,g={places:a.format.places,digitSeparator:a.format.digitSeparator}),h=a.fieldInfos,b=a.labelPlacement,null!=a.useCodedValues&&(d=a.useCodedValues));if("always-horizontal"==b||"esriServerPolygonPlacementAlwaysHorizontal"==b)e=!1;return{useCodedValues:d,dateFormat:c,numberFormat:g,fieldInfos:h,pointPriorities:"above-center"==b||"esriServerPointLabelPlacementAboveCenter"==
b?"AboveCenter":"above-left"==b||"esriServerPointLabelPlacementAboveLeft"==b?"AboveLeft":"above-right"==b||"esriServerPointLabelPlacementAboveRight"==b?"AboveRight":"below-center"==b||"esriServerPointLabelPlacementBelowCenter"==b?"BelowCenter":"below-left"==b||"esriServerPointLabelPlacementBelowLeft"==b?"BelowLeft":"below-right"==b||"esriServerPointLabelPlacementBelowRight"==b?"BelowRight":"center-center"==b||"esriServerPointLabelPlacementCenterCenter"==b?"CenterCenter":"center-left"==b||"esriServerPointLabelPlacementCenterLeft"==
b?"CenterLeft":"center-right"==b||"esriServerPointLabelPlacementCenterRight"==b?"CenterRight":"AboveRight",lineLabelPlacement:"above-start"==b||"below-start"==b||"center-start"==b?"PlaceAtStart":"above-end"==b||"below-end"==b||"center-end"==b?"PlaceAtEnd":"PlaceAtCenter",lineLabelPosition:"above-after"==b||"esriServerLinePlacementAboveAfter"==b||"above-along"==b||"esriServerLinePlacementAboveAlong"==b||"above-before"==b||"esriServerLinePlacementAboveBefore"==b||"above-start"==b||"esriServerLinePlacementAboveStart"==
b||"above-end"==b||"esriServerLinePlacementAboveEnd"==b?"Above":"below-after"==b||"esriServerLinePlacementBelowAfter"==b||"below-along"==b||"esriServerLinePlacementBelowAlong"==b||"below-before"==b||"esriServerLinePlacementBelowBefore"==b||"below-start"==b||"esriServerLinePlacementBelowStart"==b||"below-end"==b||"esriServerLinePlacementBelowEnd"==b?"Below":"center-after"==b||"esriServerLinePlacementCenterAfter"==b||"center-along"==b||"esriServerLinePlacementCenterAlong"==b||"center-before"==b||"esriServerLinePlacementCenterBefore"==
b||"center-start"==b||"esriServerLinePlacementCenterStart"==b||"center-end"==b||"esriServerLinePlacementCenterEnd"==b?"OnLine":"Above",labelRotation:e,howManyLabels:"OneLabel"}}});C("extend-esri")&&l.setObject("layers.LabelLayer",n,D);return n});